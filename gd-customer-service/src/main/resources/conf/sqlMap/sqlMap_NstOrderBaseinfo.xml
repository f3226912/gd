<?xml version="1.0" encoding="UTF-8" ?>
<sqlMap namespace="NstOrderBaseinfo">
	<sql id="getByOrderNo">                 
 	<![CDATA[
 		SELECT
			nob.id,
			nob.orderNo,
			nob.orderType,
			nob.orderTime,
			nob.f_address_detail,
			nob.s_address_detail,
			nob.shipperMobile,
			nob.orderStatus,
			nob.shipperName,
			ma.goodsName,
			ma.totalSize,
			ma.totalWeight,
			CASE ma.sendGoodsType
			WHEN 0 THEN '零担'
			WHEN 1 THEN '整车'
			WHEN 2 THEN '不限'
			ELSE '不限' END AS sendGoodsTypeString,
			ma.sendDate,
			nob.ownerName,
			nob.ownerMobile,
			car.carNumber,
			mc.nst_idCard,
			mc.cardPhotoUrl,
			car.userId as ownerMemberId,
			ma.createUserId as shipperId
		FROM
			nst_order_baseinfo nob
			LEFT JOIN member_address ma ON nob.memberAddressId = ma.id
			LEFT JOIN member_certifi mc ON nob.memberId = mc.memberId
			LEFT JOIN cars car  ON nob.carId=car.id
 		WHERE
 			nob.orderNo = :orderNo
 	]]>
 	</sql>
 	
 	<sql id="getStatusByOrderNo">                 
 	<![CDATA[
 		SELECT
			nob.orderStatus
		FROM
			nst_order_baseinfo nob
 		WHERE
 			nob.orderNo = :orderNo
 	]]>
 	</sql>
	
<sql id="getMemberSameCityOrderCount">                 
	 	<![CDATA[
	 		SELECT
				COUNT(id)
			FROM
				(
					SELECT
						nob.id
					FROM
						nst_order_baseinfo nob
					WHERE
						nob.orderStatus = 1
					AND nob.sourceType = 1
					AND nob.orderType = 1
					AND nob.memberId = :memberId
					UNION ALL
						SELECT
							nob1.id
						FROM
							nst_order_baseinfo nob1
						WHERE
							nob1.orderStatus = 1
						AND nob1.sourceType = 1
						AND nob1.orderType = 2
						AND nob1.confirmMemberId = :memberId
				) n
	 	]]>
 	</sql>
 	
 	<sql id="autoCancelOrderBySameCity">                 
	 	<![CDATA[
	 		UPDATE nst_order_baseinfo
			SET orderStatus = 5
			WHERE
				id IN (
					SELECT
						n.id
					FROM
						(
							SELECT
								id
							FROM
								nst_order_baseinfo
							WHERE
								orderStatus = 1
							AND sourceType = 1
							AND (isDeleted is NULL OR isDeleted=0)
							AND DATE_SUB(SYSDATE(), INTERVAL 20 MINUTE) >= orderTime
						) n
				)
	 	]]>
 	</sql><sql id="getOrderBaseByMemberAddressId">                  	<![CDATA[ 
 		<#if memberAddressId?? && source==1>
		 		SELECT
					nob.orderNo,
					nob.same_memberAddressId,
					nob.orderStatus,
					ma.createUserId AS shipperId
				FROM
					nst_order_baseinfo nob
				LEFT JOIN nst_same_city_address ma ON nob.same_memberAddressId = ma.id
				WHERE
					1 = 1
				AND ma.id = :memberAddressId
				ORDER BY
					nob.updateTime DESC
				LIMIT 1 
	 		<#else>
		 		SELECT
		 			nob.orderNo,
		 			nob.memberAddressId,
		 			nob.orderStatus,
		 			ma.createUserId as shipperId
		 		FROM
		 			nst_order_baseinfo nob
		 		LEFT JOIN member_address ma ON nob.memberAddressId = ma.id
		 		WHERE
		 			1 = 1
		 		<#if memberAddressId?exists && memberAddressId!="">
		 			AND nob.memberAddressId = :memberAddressId
		 		</#if>
		 		ORDER BY 
		 			nob.updateTime DESC 
		 		LIMIT 1	 		
	 	</#if>
 	]]>
 	</sql>
 	
 	<sql id="autoComfirmOrder">                 
 	<![CDATA[ 
 		UPDATE
 			nst_order_baseinfo
 		SET
 			orderStatus = 3
 		WHERE
 			TIMESTAMPDIFF(SECOND,orderTime, SYSDATE()) >= 7 * 24 * 3600 AND orderStatus = 2
 	]]>
 	</sql>
	
	<sql id="getMemberInfoByMemberId">
	<![CDATA[
		SELECT
			IF (
				mb.userType = 1,
				mb.realName,
				mc.linkMan
			) AS `name`,

			IF (
				mb.userType = 1,
				mb.mobile,
				mc.mobile
			) AS `mobile`,
			mb.andupurl,
			mc.nstStatus AS isCertify
		FROM
		member_baseinfo mb
		LEFT JOIN member_certifi mc ON mb.memberId = mc.memberId
		WHERE mb.memberId = :memberId
	]]>
	</sql>
	
	<sql id="acceptOrder">
	<![CDATA[
		UPDATE nst_order_baseinfo SET orderStatus=2,order_confirmTime=SYSDATE(),updateTime=SYSDATE(),updateUserId=:memberId WHERE orderNo=:orderNo
	]]>
	</sql>
	
	<sql id="refuseOrder">
	<![CDATA[
		UPDATE nst_order_baseinfo SET orderStatus=4,updateTime=SYSDATE(),updateUserId=:memberId WHERE orderNo=:orderNo
	]]>
	</sql>
	<sql id="confirmGoods">
		<![CDATA[
		UPDATE nst_order_baseinfo SET orderStatus=3,order_completeTime=SYSDATE(),updateTime=SYSDATE(),updateUserId=:memberId WHERE orderNo=:orderNo
		]]>
	</sql>
	
	<sql id="cancelOrder">
		<![CDATA[
		UPDATE nst_order_baseinfo SET orderStatus=5,updateTime=SYSDATE(),updateUserId=:memberId WHERE orderNo=:orderNo
		]]>
	</sql>
	
	<sql id="saveStartTimeByOrderNo">
		<![CDATA[
		UPDATE nst_order_baseinfo SET startTime=SYSDATE() WHERE orderNo=:orderNo
		]]>
	</sql>
	
	<sql id="batchDeleteOrder">
		<![CDATA[
		UPDATE nst_order_baseinfo SET isDeleted=IFNULL(isDeleted,0)+1,updateTime=SYSDATE(),updateUserId=:memberId,deleteMemberId=:memberId 
		WHERE 
		orderNo IN 
		<#assign n = orderNoList?size />
			<#if n gt 0>
				(
				<#list orderNoList as omId>
					<#if omId_index != n-1>
							${omId} ,
						<#else>
							${omId}
					</#if>
				</#list>
				) 
			</#if>
		]]>
	</sql>
	
	<sql id="getCarLineInfoByCarLineId">
		<![CDATA[
			SELECT
				line.memberId AS ownerMemberId,
				car.carNumber,
				line.carId,
				line.id AS carLineId,
				IF (
				mc.nst_idCard IS NOT NULL && mc.nstStatus = '1',
				mc.nst_idCard,
				''
				) AS nst_idCard,
				IF (
				mc.nst_cardPhotoUrl IS NOT NULL && mc.nstStatus = '1',
				mc.nst_cardPhotoUrl,
				''
				) AS nst_cardPhotoUrl,
				IF (
				car.nst_vehiclePhotoUrl IS NOT NULL && mc.nstStatus = '1',
				car.nst_vehiclePhotoUrl,
				''
				) AS nst_vehiclePhotoUrl,
				IF (
				car.nst_driverPhotoUrl IS NOT NULL && mc.nstStatus = '1',
				car.nst_driverPhotoUrl,
				''
				) AS nst_driverPhotoUrl
			FROM
				carline line
				LEFT JOIN cars car ON line.carId = car.id
				LEFT JOIN member_certifi mc ON line.memberId = mc.memberId
			WHERE 1=1
			<#if carLineId?exists && carLineId!="" >
				AND line.id=:carLineId
			</#if>
		]]>
	</sql>
	
	<sql id="getSameCarLineInfoByCarLineId">
		<![CDATA[
			SELECT
				line.memberId AS ownerMemberId,
				car.carNumber,
				line.carId,
				line.id AS carLineId,
				IF (
				mc.nst_idCard IS NOT NULL && mc.nstStatus = '1',
				mc.nst_idCard,
				''
				) AS nst_idCard,
				IF (
				mc.nst_cardPhotoUrl IS NOT NULL && mc.nstStatus = '1',
				mc.nst_cardPhotoUrl,
				''
				) AS nst_cardPhotoUrl,
				IF (
				car.nst_vehiclePhotoUrl IS NOT NULL && mc.nstStatus = '1',
				car.nst_vehiclePhotoUrl,
				''
				) AS nst_vehiclePhotoUrl,
				IF (
				car.nst_driverPhotoUrl IS NOT NULL && mc.nstStatus = '1',
				car.nst_driverPhotoUrl,
				''
				) AS nst_driverPhotoUrl
			FROM
				nst_same_city_carline line
				LEFT JOIN cars car ON line.carId = car.id
				LEFT JOIN member_certifi mc ON line.memberId = mc.memberId
			WHERE 1=1
			<#if carLineId?exists && carLineId!="" >
				AND line.id=:carLineId
			</#if>
		]]>
	</sql>
	
	<sql id="getNstOrderListByCondition">
		<![CDATA[
			SELECT
				nob.id,
				nob.sourceType,
				nob.orderNo,
				nob.orderType,
				nob.orderTime,
				nob.confirmMemberId,
				nob.memberId,
				nob.f_address_detail,
				nob.s_address_detail,
				nob.shipperName,
				nob.shipperMobile,
				nob.orderStatus,
				nob.startTime,
				ma.goodsName,
				ma.totalSize,
				ma.totalWeight,
				ma.hundredweight,
				ma.contactName,
				ma.s_detailed_address,
				ma.f_detailed_address,
				ma.id AS memberAddressId,
				CASE ma.sendGoodsType
				WHEN 0 THEN '零担'
				WHEN 1 THEN '整车'
				WHEN 2 THEN '不限'
				ELSE '不限' END AS sendGoodsTypeString,
				<#--同城订单所需字段-->
				CONCAT((SELECT area FROM area WHERE areaID=nsca.s_cityId),(SELECT area FROM area WHERE areaID=nsca.s_areaId)) AS s_name,
				CONCAT((SELECT area FROM area WHERE areaID=nsca.f_cityId),(SELECT area FROM area WHERE areaID=nsca.f_areaId)) AS f_name,
				nsca.s_detail,
				nsca.f_detail,
				nsca.s_detailed_address,
				nsca.f_detailed_address,
				nsca.goodsType,
				nsca.s_lng,
				nsca.s_lat,
				nsca.f_lng,
				nsca.f_lat,
				nsca.totalWeight AS sameTotalWeight,
				nsca.totalSize AS sameTotalSize,
				nsca.price,
				nsca.remark,
				<#--同城订单所需字段结束-->
				nob.ownerName,
				nob.ownerMobile,
				car.carNumber,
				nob.deleteMemberId,
				nob.isDeleted,
				IF (
				mc.nst_idCard IS NOT NULL && mc.nstStatus = '1',
				mc.nst_idCard,
				''
				) AS nst_idCard,
				IF (
				mc.nst_cardPhotoUrl IS NOT NULL && mc.nstStatus = '1',
				mc.nst_cardPhotoUrl,
				''
				) AS nst_cardPhotoUrl,
				IF (
				car.nst_vehiclePhotoUrl IS NOT NULL && mc.nstStatus = '1',
				car.nst_vehiclePhotoUrl,
				''
				) AS nst_vehiclePhotoUrl,
				IF (
				car.nst_driverPhotoUrl IS NOT NULL && mc.nstStatus = '1',
				car.nst_driverPhotoUrl,
				''
				) AS nst_driverPhotoUrl
			FROM
				nst_order_baseinfo nob
				LEFT JOIN member_address ma ON nob.memberAddressId = ma.id
				LEFT JOIN nst_same_city_address nsca ON nob.same_memberAddressId=nsca.id
				LEFT JOIN cars car ON nob.carId = car.id
				LEFT JOIN member_certifi mc ON car.userId = mc.memberId
			WHERE 1=1 
			<#--当isDeleted=1 但是删除memberId不等于前台传过来的memberId 则表示此订单在此会员下没有删除-->
			<#if memberId?exists && memberId!="" >
				AND (nob.isDeleted IS NULL OR nob.isDeleted='0' OR (nob.deleteMemberId <> :memberId AND  nob.isDeleted='1'))
			</#if>
			<#if sourceType?exists && sourceType!="" && sourceType==1 >
				AND nob.sourceType =1
			</#if>
			<#if sourceType?exists && sourceType!="" && sourceType==0 >
				AND (nob.sourceType =0 || nob.sourceType is NULL)
			</#if>
			<#if id?exists && id!="" >
				AND nob.id = :id 
			</#if>
			<#if orderType?exists && orderType!="" >
				AND nob.orderType = :orderType 
			</#if>
			<#if memberId?exists && memberId!="" >
				AND (nob.memberId = :memberId OR nob.confirmMemberId = :memberId) 
			</#if>
			<#if orderNo?exists && orderNo!="" >
				AND  nob.orderNo=:orderNo
			</#if>
			<#if s_provinceId?exists && s_provinceId!="" >
				AND  ma.s_provinceId=:s_provinceId
			</#if>
			<#if s_cityId?exists && s_cityId!="" >
				AND  ma.s_cityId=:s_cityId
			</#if>
			<#if s_areaId?exists && s_areaId!="" >
				AND  ma.s_areaId=:s_areaId
			</#if>
			<#if f_provinceId?exists && f_provinceId!="" >
				AND  ma.f_provinceId=:f_provinceId
			</#if>
			<#if f_cityId?exists && f_cityId!="" >
				AND  ma.f_cityId=:f_cityId
			</#if>
			<#if f_areaId?exists && f_areaId!="" >
				AND  ma.f_areaId=:f_areaId
			</#if>
			<#if shipperName?exists && shipperName!="" >
				AND  nob.shipperName like "%":shipperName"%"
			</#if>
			<#if shipperMobile?exists && shipperMobile!="" >
				AND  nob.shipperMobile=:shipperMobile
			</#if>
			<#if ownerName?exists && ownerName!="" >
				AND  nob.ownerName=:ownerName
			</#if>
			<#if ownerMobile?exists && ownerMobile!="" >
				AND  nob.ownerMobile like "%":ownerMobile"%"
			</#if>
			<#if beginTime?exists && beginTime!="" >
				AND  ma.sendDate >=:beginTime
			</#if>
			<#if endTime?exists && endTime!="" >
				AND  ma.sendDate <=:endTime
			</#if>
			<#if orderStatus?exists && orderStatus!="" >
				AND  nob.orderStatus =:orderStatus
			</#if>
			<#if canDelete?exists && canDelete!="" >
				AND  nob.orderStatus in (3,4,5)
			</#if>
			<#if showRejectAndCal?exists && showRejectAndCal!="" >
				AND  nob.orderStatus in (4,5)
			</#if>
			order by nob.orderStatus,nob.orderTime desc
			<#if startRow?exists && startRow!="" && endRow?exists && endRow!="" >
				LIMIT :startRow,:endRow
			</#if>
			
		]]>
	</sql>
	
	<sql id="getNstOrderListByConditionTotal">
		<![CDATA[
			SELECT
				count(nob.id)
			FROM
				nst_order_baseinfo nob
				LEFT JOIN member_address ma ON nob.memberAddressId = ma.id
				LEFT JOIN nst_same_city_address nsca ON nob.same_memberAddressId=nsca.id
				LEFT JOIN cars car ON nob.carId = car.id
				LEFT JOIN member_certifi mc ON car.userId = mc.memberId
			WHERE 1=1 
			<#if memberId?exists && memberId!="" >
				AND (nob.isDeleted IS NULL OR nob.isDeleted='0' OR (nob.deleteMemberId <> :memberId AND  nob.isDeleted='1'))
			</#if>
			<#if sourceType?exists && sourceType!="" && sourceType==1 >
				AND nob.sourceType =1
			</#if>
			<#if sourceType?exists && sourceType!="" && sourceType==0 >
				AND (nob.sourceType =0 || nob.sourceType is NULL)
			</#if>
			<#if id?exists && id!="" >
				AND nob.id = :id 
			</#if>
			<#if orderType?exists && orderType!="" >
				AND nob.orderType = :orderType 
			</#if>
			<#if memberId?exists && memberId!="" >
				AND (nob.memberId = :memberId OR nob.confirmMemberId = :memberId) 
			</#if>
			<#if orderNo?exists && orderNo!="" >
				AND  nob.orderNo=:orderNo
			</#if>
			<#if s_provinceId?exists && s_provinceId!="" >
				AND  ma.s_provinceId=:s_provinceId
			</#if>
			<#if s_cityId?exists && s_cityId!="" >
				AND  ma.s_cityId=:s_cityId
			</#if>
			<#if s_areaId?exists && s_areaId!="" >
				AND  ma.s_areaId=:s_areaId
			</#if>
			<#if f_provinceId?exists && f_provinceId!="" >
				AND  ma.f_provinceId=:f_provinceId
			</#if>
			<#if f_cityId?exists && f_cityId!="" >
				AND  ma.f_cityId=:f_cityId
			</#if>
			<#if f_areaId?exists && f_areaId!="" >
				AND  ma.f_areaId=:f_areaId
			</#if>
			<#if shipperName?exists && shipperName!="" >
				AND  nob.shipperName like "%":shipperName"%"
			</#if>
			<#if shipperMobile?exists && shipperMobile!="" >
				AND  nob.shipperMobile=:shipperMobile
			</#if>
			<#if ownerName?exists && ownerName!="" >
				AND  nob.ownerName=:ownerName
			</#if>
			<#if ownerMobile?exists && ownerMobile!="" >
				AND  nob.ownerMobile like "%":ownerMobile"%"
			</#if>
			<#if beginTime?exists && beginTime!="" >
				AND  ma.sendDate >=:beginTime
			</#if>
			<#if endTime?exists && endTime!="" >
				AND  ma.sendDate <=:endTime
			</#if>
			<#if orderStatus?exists && orderStatus!="" >
				AND  nob.orderStatus =:orderStatus
			</#if>
		]]>
	</sql>
	
<!-- 后台统计订单总共记录数  -->
	<sql id="getTotal">
	<![CDATA[
		SELECT 
			count(1)  
		FROM 
			 nst_order_baseinfo b
		WHERE  
			1=1 
			<#if orderNo?exists && orderNo!="" >
			     AND b.orderNo =:orderNo 
			</#if> 
			<#if shipperName?exists && shipperName!="" >
			     AND b.shipperName like "%":shipperName"%"
			</#if> 
			<#if shipperMobile?exists && shipperMobile!="" >
			     AND b.shipperMobile =:shipperMobile 
			</#if> 
			<#if ownerName?exists && ownerName!="" >
			     AND b.ownerName like "%":ownerName"%"
			</#if>
			<#if ownerMobile?exists && ownerMobile!="" >
			     AND b.ownerMobile =:ownerMobile 
			</#if>  
			<#if startDate?exists && startDate!="" >
			     AND DATE_FORMAT(orderTime,'%Y-%c-%d') >= DATE_FORMAT(:startDate,'%Y-%c-%d')
			</#if> 
			<#if endDate?exists && endDate!="" >
			     AND DATE_FORMAT(orderTime,'%Y-%c-%d') <= DATE_FORMAT(:endDate,'%Y-%c-%d')
			</#if>
			<#if orderStatus?exists && orderStatus!="" >
				 AND  b.orderStatus =:orderStatus
			</#if>	
			<#if isDeleted?exists && isDeleted =="1" >
				 AND  b.isDeleted =:isDeleted
			</#if>
			<#if isDeleted?exists && isDeleted =="0" >
		       	AND ( b.isDeleted is NULL or b.isDeleted ='0'  )
			</#if>
			<#if transportType?exists && transportType =="0" >
			    AND (b.sourceType is NULL OR b.sourceType=0)
			</#if>	
			<#if transportType?exists && transportType =="1" >
				 AND b.sourceType =1
			</#if>	
	]]>
	</sql>
	
	 <!-- 后台订单列表  -->
	 <sql id="getByCondition" >
    	<![CDATA[
	   SELECT 
			b.id, orderNo, orderType,f_address_detail, s_address_detail , b.isDeleted,
			orderStatus, orderTime , shipperName, shipperMobile, ownerName,ownerMobile
			FROM
			nst_order_baseinfo b
			WHERE  1=1 
			<#if orderNo?exists && orderNo!="" >
			     AND b.orderNo =:orderNo 
			</#if> 
			<#if shipperName?exists && shipperName!="" >
			     AND b.shipperName like "%":shipperName"%"
			</#if> 
			<#if shipperMobile?exists && shipperMobile!="" >
			     AND b.shipperMobile =:shipperMobile 
			</#if> 
			<#if ownerName?exists && ownerName!="" >
			     AND b.ownerName like "%":ownerName"%"
			</#if>
			<#if ownerMobile?exists && ownerMobile!="" >
			     AND b.ownerMobile =:ownerMobile 
			</#if>  
			<#if startDate?exists && startDate!="" >
			     AND DATE_FORMAT(orderTime,'%Y-%c-%d') >= DATE_FORMAT(:startDate,'%Y-%c-%d')
			</#if> 
			<#if endDate?exists && endDate!="" >
			     AND DATE_FORMAT(orderTime,'%Y-%c-%d') <= DATE_FORMAT(:endDate,'%Y-%c-%d')
			</#if>
			<#if orderStatus?exists && orderStatus!="" >
				 AND  b.orderStatus =:orderStatus
			</#if>	
			<#if isDeleted?exists && isDeleted =="1" >
				 AND  b.isDeleted =:isDeleted
			</#if>
			<#if isDeleted?exists && isDeleted =="0" >
		       	AND ( b.isDeleted is NULL or b.isDeleted ='0'  )
			</#if>
			<#if transportType?exists && transportType =="0" >
			    AND (b.sourceType is NULL OR b.sourceType=0)
			</#if>	
			<#if transportType?exists && transportType =="1" >
				 AND b.sourceType =1
			</#if>	
			        order by orderTime desc 
					LIMIT :startRow,:endRow
			
		]]>
    </sql>
	
	
	
	<!-- 同城后台统计订单总共记录数  -->
	<sql id="getSameCityOrdersTotal">
	<![CDATA[
		SELECT 
			count(1)  
		FROM 
			 nst_order_baseinfo b
		WHERE  
			1=1   AND b.sourceType =1
			<#if orderNo?exists && orderNo!="" >
			     AND b.orderNo =:orderNo 
			</#if> 
			<#if shipperName?exists && shipperName!="" >
			     AND b.shipperName like "%":shipperName"%"
			</#if> 
			<#if shipperMobile?exists && shipperMobile!="" >
			     AND b.shipperMobile =:shipperMobile 
			</#if> 
			<#if ownerName?exists && ownerName!="" >
			     AND b.ownerName like "%":ownerName"%"
			</#if>
			<#if ownerMobile?exists && ownerMobile!="" >
			     AND b.ownerMobile =:ownerMobile 
			</#if>  
			<#if startDate?exists && startDate!="" >
			     AND DATE_FORMAT(orderTime,'%Y-%c-%d') >= DATE_FORMAT(:startDate,'%Y-%c-%d')
			</#if> 
			<#if endDate?exists && endDate!="" >
			     AND DATE_FORMAT(orderTime,'%Y-%c-%d') <= DATE_FORMAT(:endDate,'%Y-%c-%d')
			</#if>
			<#if orderStatus?exists && orderStatus!="" >
				 AND  b.orderStatus =:orderStatus
			</#if>	
			<#if isDeleted?exists && isDeleted =="1" >
				 AND  b.isDeleted =:isDeleted
			</#if>
			<#if isDeleted?exists && isDeleted =="0" >
		       	AND ( b.isDeleted is NULL or b.isDeleted ='0'  )
			</#if>
	]]>
	</sql>
	
	 <!-- 同城后台订单列表  -->
	 <sql id="getSameCityOrdersByCondition" >
    	<![CDATA[
	   SELECT 
			b.id, orderNo, orderType,f_address_detail, s_address_detail , b.isDeleted,
			orderStatus, orderTime , shipperName, shipperMobile, ownerName,ownerMobile ,same_memberAddressId,
			nsca.s_provinceId, nsca.s_cityId,nsca.s_areaId,nsca.s_detail,
			nsca.f_provinceId,nsca.f_cityId,nsca.f_areaId,nsca.f_detail
			FROM
			nst_order_baseinfo b
			LEFT JOIN nst_same_city_address nsca ON b.same_memberAddressId = nsca.id
			WHERE  1=1   AND b.sourceType =1
			<#if orderNo?exists && orderNo!="" >
			     AND b.orderNo =:orderNo 
			</#if> 
			<#if shipperName?exists && shipperName!="" >
			     AND b.shipperName like "%":shipperName"%"
			</#if> 
			<#if shipperMobile?exists && shipperMobile!="" >
			     AND b.shipperMobile =:shipperMobile 
			</#if> 
			<#if ownerName?exists && ownerName!="" >
			     AND b.ownerName like "%":ownerName"%"
			</#if>
			<#if ownerMobile?exists && ownerMobile!="" >
			     AND b.ownerMobile =:ownerMobile 
			</#if>  
			<#if startDate?exists && startDate!="" >
			     AND DATE_FORMAT(orderTime,'%Y-%c-%d') >= DATE_FORMAT(:startDate,'%Y-%c-%d')
			</#if> 
			<#if endDate?exists && endDate!="" >
			     AND DATE_FORMAT(orderTime,'%Y-%c-%d') <= DATE_FORMAT(:endDate,'%Y-%c-%d')
			</#if>
			<#if orderStatus?exists && orderStatus!="" >
				 AND  b.orderStatus =:orderStatus
			</#if>	
			<#if isDeleted?exists && isDeleted =="1" >
				 AND  b.isDeleted =:isDeleted
			</#if>
			<#if isDeleted?exists && isDeleted =="0" >
		       	AND ( b.isDeleted is NULL or b.isDeleted ='0'  )
			</#if>
			        order by orderTime desc 
					LIMIT :startRow,:endRow
			
		]]>
    </sql>
	
	
	
	
	<!-- 后台统计订单评论总共记录数  -->
	<sql id="getCommentTotal">
	<![CDATA[
		 SELECT 
			count(1)  
			FROM
			 nst_order_baseinfo b
      LEFT JOIN nst_order_comment c	
      ON b.orderNo = c.orderNo	
		WHERE  
			1=1 
			<#if orderNo?exists && orderNo!="" >
			     AND b.orderNo =:orderNo 
			</#if> 
			<#if shipperName?exists && shipperName!="" >
			     AND b.shipperName like "%":shipperName"%"
			</#if> 
			<#if shipperMobile?exists && shipperMobile!="" >
			     AND b.shipperMobile =:shipperMobile 
			</#if> 
			<#if ownerName?exists && ownerName!="" >
			     AND b.ownerName like "%":ownerName"%"
			</#if>
			<#if ownerMobile?exists && ownerMobile!="" >
			     AND b.ownerMobile =:ownerMobile 
			</#if>  
			<#if startDate?exists && startDate!="" >
			     AND DATE_FORMAT(orderTime,'%Y-%c-%d') >= DATE_FORMAT(:startDate,'%Y-%c-%d')
			</#if> 
			<#if endDate?exists && endDate!="" >
			     AND DATE_FORMAT(orderTime,'%Y-%c-%d') <= DATE_FORMAT(:endDate,'%Y-%c-%d')
			</#if>
			<#if orderStatus?exists && orderStatus!="" >
				 AND  b.orderStatus =:orderStatus
			</#if>	
			 <#if evaluateType?exists && evaluateType !="" && evaluateType !="3" >
				 AND  c.evaluateType =:evaluateType
			 </#if>	
			 <#if evaluateType?exists && evaluateType =="3" >
				 AND  c.orderNo IS NULL
			 </#if>	
	]]>
	</sql>
	
	
	<sql id="getCommentListByCondition" >
    	<![CDATA[
	  SELECT 
			c.id, b.orderNo, orderType,f_address_detail, s_address_detail ,  
			orderStatus, orderTime , shipperName, shipperMobile, ownerName,ownerMobile,
            c.type, c.evaluateType , c.serviceEvaluate , c.`comment`
			FROM
			nst_order_baseinfo b
      LEFT JOIN nst_order_comment c	
      ON b.orderNo = c.orderNo	
		WHERE  
			1=1 
			<#if orderNo?exists && orderNo!="" >
			     AND b.orderNo =:orderNo 
			</#if> 
			<#if shipperName?exists && shipperName!="" >
			     AND b.shipperName like "%":shipperName"%"
			</#if> 
			<#if shipperMobile?exists && shipperMobile!="" >
			     AND b.shipperMobile =:shipperMobile 
			</#if> 
			<#if ownerName?exists && ownerName!="" >
			     AND b.ownerName like "%":ownerName"%"
			</#if>
			<#if ownerMobile?exists && ownerMobile!="" >
			     AND b.ownerMobile =:ownerMobile 
			</#if>  
			<#if startDate?exists && startDate!="" >
			     AND DATE_FORMAT(orderTime,'%Y-%c-%d') >= DATE_FORMAT(:startDate,'%Y-%c-%d')
			</#if> 
			<#if endDate?exists && endDate!="" >
			     AND DATE_FORMAT(orderTime,'%Y-%c-%d') <= DATE_FORMAT(:endDate,'%Y-%c-%d')
			</#if>
			<#if orderStatus?exists && orderStatus!="" >
				 AND  b.orderStatus =:orderStatus
			</#if>	
			 <#if evaluateType?exists && evaluateType !="" && evaluateType !="3" >
				 AND  c.evaluateType =:evaluateType
			 </#if>	
			 <#if evaluateType?exists && evaluateType =="3" >
				 AND  c.orderNo IS NULL
			 </#if>	
			
			        order by orderTime desc 
					LIMIT :startRow,:endRow
			
		]]>
    </sql>
    
	<sql id="getOrderStatusCountByMemberId" >
    	<![CDATA[
			SELECT
				nob.orderStatus,
				COUNT(nob.id) AS submitCount
			FROM
				nst_order_baseinfo nob
			WHERE 1=1 
			<#if memberId?exists && memberId!="" >
				AND (nob.isDeleted IS NULL OR nob.isDeleted='0' OR (nob.deleteMemberId <> :memberId AND nob.isDeleted='1'))
				AND (nob.memberId = :memberId OR nob.confirmMemberId = :memberId) 
			</#if>
			GROUP BY
			nob.orderStatus		
		]]>
    </sql>
    
    <sql id="getEvaluateTypeCountByMemberId" >
    	<![CDATA[
			SELECT
				COUNT(id)
			FROM
				nst_order_comment
			WHERE evaluateType = '1'
			<#if memberId?exists && memberId!="" >
				AND memberId = :memberId
			</#if>			
		]]>
    </sql>
    
    <sql id="memberAddressOrderStatus">
    	<![CDATA[
			SELECT
				n.orderStatus
			FROM
				(
					SELECT
						nob.orderStatus,
						nob.memberAddressId
					FROM
						nst_order_baseinfo nob
					WHERE
						nob.memberAddressId IS NOT NULL
					ORDER BY
						id DESC
				) n
			GROUP BY
				n.memberAddressId 
			HAVING n.memberAddressId= :id		
		]]>
    </sql>
    <sql id="sameMemberAddressOrderStatus">
    	<![CDATA[
			SELECT
				n.orderStatus
			FROM
				(
					SELECT
						nob.orderStatus,
						nob.same_memberAddressId
					FROM
						nst_order_baseinfo nob
					WHERE
						nob.same_memberAddressId IS NOT NULL
					ORDER BY
						id DESC
				) n
			GROUP BY
				n.same_memberAddressId
			 HAVING n.same_memberAddressId= :id		
		]]>
    </sql>
	
	<sql id="getOrderNoByCondition">
	<![CDATA[
		SELECT 
			orderNo 
		FROM 
			nst_order_baseinfo 
		WHERE
			1 = 1
		<#if memberId?exists && memberId!="" >
			 AND (nob.isDeleted IS NULL OR nob.isDeleted='0' OR (nob.deleteMemberId <> :memberId AND nob.isDeleted='1'))
			 AND (memberId = :memberId OR confirmMemberId = :memberId)
		</#if>
		<#if orderStatus?exists && orderStatus!="" >
			 AND orderStatus = :orderStatus
		</#if>
	]]>
	</sql>
	
	<sql id="getCount">
	<![CDATA[
		SELECT
			COUNT(id) AS count
		FROM
			nst_order_baseinfo
		WHERE orderStatus = 1
		<#if memberId?exists && memberId!="" >
			 AND confirmMemberId = :memberId
		</#if>
		<#if orderType?exists && orderType!="" >
			 AND orderType = :orderType
		</#if>
		<#if sourceType?exists && sourceType!="" >
			 AND sourceType = :sourceType
		</#if>
	]]>
	</sql>
	
		<sql id="getOrderStatusCount" >
    	<![CDATA[
			SELECT
				COUNT(nob.id) 
			FROM
				nst_order_baseinfo nob
			WHERE 1=1
			and nob.orderStatus not in (4,5)
			<#if memberId?exists && memberId!="" >
				AND (nob.memberId = :memberId OR nob.confirmMemberId = :memberId) 
			</#if>	
		]]>
    </sql>
    
    		<sql id="getMemberadressCount" >
    	<![CDATA[
			SELECT COUNT(id)  FROM member_address WHERE userId=:memberId
		]]>
    </sql>
    
    		<sql id="getCarLineCount" >
    	<![CDATA[
			SELECT COUNT(id) from carline WHERE memberId=:memberId
		]]>
    </sql>
        		<sql id="getCarsDTOByMemberId" >
    	<![CDATA[
			SELECT  nst_vehiclePhotoUrl ,  nst_driverPhotoUrl   from cars  WHERE userId=:memberId
		]]>
    </sql>
    
    <sql id="getOrderCountList">                 
 	<![CDATA[
 		<#--农速通统计列表页-->
		SELECT
			nob.id,
			nob.orderNo,
			nob.f_address_detail,
			nob.s_address_detail,
			ma.s_provinceId,
			ma.s_cityId,
			ma.s_areaId,
			ma.f_provinceId,
			ma.f_cityId,
			ma.f_areaId,
			nob.orderStatus,
			IF(nob.orderType='1','货源','线路') AS orderType,
			ma.goodsType,
			ma.totalWeight,
			ma.hundredweight,
			ma.totalSize,
			car.carNumber,
			nob.orderTime,
			nob.order_confirmTime,
			nob.order_completeTime,
			<#--接单者电话-->
		  	IF(mb.userType=1,mb.mobile,mc.mobile) AS receiveMobile,
			<#--接单者姓名-->
			IF(mb.userType=1,mb.realName,mc.linkMan) AS receiveName,
			<#--发布者电话-->
			IF(mb2.userType=1,mb2.mobile,mc2.mobile) AS releaseMobile,
			<#--发布者姓名-->
			IF(mb2.userType=1,mb2.realName,mc2.linkMan) AS releaseName,
			<#--发布者类型-->
			IF(mb2.userType=1,'个人','企业') AS releaseUserType,
            mc.nstStatus AS receiveNstStatus,
			mc2.nstStatus AS releaseNstStatus,
			<#--发布者推荐人电话-->
			IF(mb3.userType=1,mb3.mobile,mc3.mobile) AS releaseMobile_ed,
			<#--发布者推荐人姓名-->
			IF(mb3.userType=1,mb3.realName,mc3.linkMan) AS releaseName_ed,
			<#--发布者推荐人所属区域-->
			a_s.areaName releaseAreaName,
			<#--接单者推荐人电话-->
			IF(mb4.userType=1,mb4.mobile,mc4.mobile) AS receiveMobile_ed,
			<#--接单者推荐人姓名-->
			IF(mb4.userType=1,mb4.realName,mc4.linkMan) AS receiveName_ed,
			<#--接单者推荐人所属区域-->
			a_s2.areaName receiveAreaName
		FROM
			nst_order_baseinfo nob
		<#--查询车牌号-->
		LEFT JOIN cars car ON nob.carId=car.id
		<#--货源表 -->
		LEFT JOIN member_address ma ON nob.memberAddressId = ma.id
		<#--查询接单人员的姓名和电话-->
		LEFT JOIN member_baseinfo mb ON nob.memberId=mb.memberId
		LEFT JOIN member_certifi mc ON nob.memberId=mc.memberId
		<#--查询发布人员的姓名和电话-->
		LEFT JOIN member_baseinfo mb2 ON nob.confirmMemberId=mb2.memberId
		LEFT JOIN member_certifi mc2 ON nob.confirmMemberId=mc2.memberId
		<#--查询发布人推荐人姓名和电话 区域名称-->
		LEFT JOIN  integral i ON nob.confirmMemberId=i.memberId_ed AND i.type=3
		LEFT JOIN member_baseinfo mb3 ON i.memberId=mb3.memberId
		LEFT JOIN member_certifi mc3 ON i.memberId=mc3.memberId
		LEFT JOIN area_setting a_s ON i.memberId=a_s.memberId
		<#--查询接单者推荐人姓名和电话 区域名称-->
		LEFT JOIN integral i2 ON nob.memberId=i2.memberId_ed AND i2.type=3
		LEFT JOIN member_baseinfo mb4 ON i2.memberId=mb4.memberId
		LEFT JOIN member_certifi mc4 ON i2.memberId=mc4.memberId
		LEFT JOIN area_setting a_s2 ON i2.memberId=a_s2.memberId
		WHERE 1=1  and (nob.sourceType is NULL OR nob.sourceType=0)
		<#if orderNo?exists && orderNo!="" >
			AND nob.orderNo =:orderNo 
		</#if>
		<#if s_provinceId?exists && s_provinceId!="" >
			AND ma.s_provinceId =:s_provinceId 
		</#if>
		<#if s_cityId?exists && s_cityId!="" >
			AND ma.s_cityId =:s_cityId 
		</#if> 
		<#if s_areaId?exists && s_areaId!="" >
			AND ma.s_areaId =:s_areaId 
		</#if>
		<#if f_provinceId?exists && f_provinceId!="" >
			AND ma.f_provinceId =:f_provinceId 
		</#if>
		<#if f_cityId?exists && f_cityId!="" >
			AND ma.f_cityId =:f_cityId 
		</#if>
		<#if f_areaId?exists && f_areaId!="" >
			AND ma.f_areaId =:f_areaId 
		</#if>
		<#if orderStatus?exists && orderStatus!="" >
			AND nob.orderStatus =:orderStatus 
		</#if>
		<#if orderBeginTime?exists && orderBeginTime!="" >
			AND nob.orderTime >=:orderBeginTime 
		</#if>
		 <#if orderEndTime?exists && orderEndTime!="" >
		   AND DATE_FORMAT(nob.orderTime,'%Y-%c-%d') <= DATE_FORMAT(:orderEndTime, '%Y-%c-%d')
	    </#if>
		<#if order_completeBeginTime?exists && order_completeBeginTime!="" >
			AND nob.order_completeTime >=:order_completeBeginTime 
		</#if>
		 <#if order_completeEndTime?exists && order_completeEndTime!="" >
		   AND DATE_FORMAT(nob.order_completeTime,'%Y-%c-%d') <= DATE_FORMAT(:order_completeEndTime, '%Y-%c-%d')
	    </#if>
	    <#if order_confirmBeginTime?exists && order_confirmBeginTime!="" >
		   AND nob.order_confirmTime >=:order_confirmBeginTime
	    </#if>
	     <#if order_confirmEndTime?exists && order_confirmEndTime!="" >
		   AND nob.order_confirmTime <=:order_confirmEndTime
	    </#if>
		<#if receiveMobile?exists && receiveMobile!="" >
			AND mb.mobile =:receiveMobile 
		</#if>
		<#if releaseMobile?exists && releaseMobile!="" >
			AND mb2.mobile =:releaseMobile 
		</#if>
		<#if releaseMobile_ed?exists && releaseMobile_ed!="" >
			AND mb3.mobile =:releaseMobile_ed 
		</#if>
		<#if releaseAreaName?exists && releaseAreaName!="" >
			AND a_s.areaName =:releaseAreaName 
		</#if>
		<#if receiveMobile_ed?exists && receiveMobile_ed!="" >
			AND mb4.mobile =:receiveMobile_ed 
		</#if>
		<#if receiveAreaName?exists && receiveAreaName!="" >
			AND a_s2.areaName =:receiveAreaName 
		</#if>
		<#if transportType?exists && transportType!="" >
		   AND  car.transportType =:transportType
		</#if>	
		GROUP BY nob.id ORDER BY nob.orderTime desc
		<#if startRow?exists && startRow!="" && endRow?exists && endRow!="" >
				LIMIT :startRow,:endRow
		</#if>
 	]]>
 	</sql>
 	
 	<sql id="getOrderCountListTotal">                 
 	<![CDATA[
 		<#--农速通统计列表页-->
		SELECT count(a.id) FROM 
		( 
			SELECT
				nob.id
			FROM
				nst_order_baseinfo nob
			<#--查询车牌号-->
			LEFT JOIN cars car ON nob.carId=car.id
			<#--货源表 -->
			LEFT JOIN member_address ma ON nob.memberAddressId = ma.id
			<#--查询接单人员的姓名和电话-->
			LEFT JOIN member_baseinfo mb ON nob.memberId=mb.memberId
			LEFT JOIN member_certifi mc ON nob.memberId=mc.memberId
			<#--查询发布人员的姓名和电话-->
			LEFT JOIN member_baseinfo mb2 ON nob.confirmMemberId=mb2.memberId
			LEFT JOIN member_certifi mc2 ON nob.confirmMemberId=mc2.memberId
			<#--查询发布人推荐人姓名和电话 区域名称-->
			LEFT JOIN  integral i ON nob.confirmMemberId=i.memberId_ed AND i.type=3
			LEFT JOIN member_baseinfo mb3 ON i.memberId=mb3.memberId
			LEFT JOIN member_certifi mc3 ON i.memberId=mc3.memberId
			LEFT JOIN area_setting a_s ON i.memberId=a_s.memberId
			<#--查询接单者推荐人姓名和电话 区域名称-->
			LEFT JOIN integral i2 ON nob.memberId=i2.memberId_ed AND i2.type=3
			LEFT JOIN member_baseinfo mb4 ON i2.memberId=mb4.memberId
			LEFT JOIN member_certifi mc4 ON i2.memberId=mc4.memberId
			LEFT JOIN area_setting a_s2 ON i2.memberId=a_s2.memberId
			WHERE 1=1  and (nob.sourceType is NULL OR nob.sourceType=0)
			<#if orderNo?exists && orderNo!="" >
				AND nob.orderNo =:orderNo 
			</#if>
			<#if s_provinceId?exists && s_provinceId!="" >
				AND ma.s_provinceId =:s_provinceId 
			</#if>
			<#if s_cityId?exists && s_cityId!="" >
				AND ma.s_cityId =:s_cityId 
			</#if> 
			<#if s_areaId?exists && s_areaId!="" >
				AND ma.s_areaId =:s_areaId 
			</#if>
			<#if f_provinceId?exists && f_provinceId!="" >
				AND ma.f_provinceId =:f_provinceId 
			</#if>
			<#if f_cityId?exists && f_cityId!="" >
				AND ma.f_cityId =:f_cityId 
			</#if>
			<#if f_areaId?exists && f_areaId!="" >
				AND ma.f_areaId =:f_areaId 
			</#if>
			<#if orderStatus?exists && orderStatus!="" >
				AND nob.orderStatus =:orderStatus 
			</#if>
			<#if orderBeginTime?exists && orderBeginTime!="" >
				AND nob.orderTime >=:orderBeginTime 
			</#if>
			<#if orderEndTime?exists && orderEndTime!="" >
		     AND DATE_FORMAT(nob.orderTime,'%Y-%c-%d') <= DATE_FORMAT(:orderEndTime, '%Y-%c-%d')
	        </#if>
		    <#if order_completeBeginTime?exists && order_completeBeginTime!="" >
			AND nob.order_completeTime >=:order_completeBeginTime 
		    </#if>
		   	<#if order_completeEndTime?exists && order_completeEndTime!="" >
		  	AND DATE_FORMAT(nob.order_completeTime,'%Y-%c-%d') <= DATE_FORMAT(:order_completeEndTime, '%Y-%c-%d')
	       	</#if>
	       	<#if order_confirmBeginTime?exists && order_confirmBeginTime!="" >
			   	AND nob.order_confirmTime >=:order_confirmBeginTime
		    </#if>
		    <#if order_confirmEndTime?exists && order_confirmEndTime!="" >
				AND nob.order_confirmTime <=:order_confirmEndTime
		    </#if>
			<#if receiveMobile?exists && receiveMobile!="" >
				AND mb.mobile =:receiveMobile 
			</#if>
			<#if releaseMobile?exists && releaseMobile!="" >
				AND mb2.mobile =:releaseMobile 
			</#if>
			<#if releaseMobile_ed?exists && releaseMobile_ed!="" >
				AND mb3.mobile =:releaseMobile_ed 
			</#if>
			<#if releaseAreaName?exists && releaseAreaName!="" >
				AND a_s.areaName =:releaseAreaName 
			</#if>
			<#if receiveMobile_ed?exists && receiveMobile_ed!="" >
				AND mb4.mobile =:receiveMobile_ed 
			</#if>
			<#if receiveAreaName?exists && receiveAreaName!="" >
				AND a_s2.areaName =:receiveAreaName 
			</#if>
			<#if transportType?exists && transportType!="" >
				 AND  car.transportType =:transportType
			</#if>	
			GROUP BY nob.id
			) a

 	]]>
 	</sql>
 	
 	 <sql id="getOrderCountDetailByOrderNo" >
    	<![CDATA[
    		<#--农速通统计详情页-->
			SELECT
				nob.id,
				nob.orderNo,
				nob.f_address_detail,
				nob.s_address_detail,
				ma.s_provinceId,
				ma.s_cityId,
				ma.s_areaId,
				ma.f_provinceId,
				ma.f_cityId,
				ma.f_areaId,
				nob.orderStatus,
				IF(nob.orderType='1','货源','线路') AS orderType,
				ma.goodsType,
				ma.totalWeight,
				ma.hundredweight,
				ma.totalSize,
				car.carNumber,
				nob.orderTime,
				nob.order_confirmTime,
				nob.order_completeTime,
				<#--接单者电话-->
			  	IF(mb.userType=1,mb.mobile,mc.mobile) AS receiveMobile,
				<#--接单者姓名-->
				IF(mb.userType=1,mb.realName,mc.linkMan) AS receiveName,
				<#--发布者电话-->
				IF(mb2.userType=1,mb2.mobile,mc2.mobile) AS releaseMobile,
				<#--发布者姓名-->
				IF(mb2.userType=1,mb2.realName,mc2.linkMan) AS releaseName,
				<#--发布者类型-->
				IF(mb2.userType=1,'个人','企业') AS releaseUserType,
                mc.nstStatus AS receiveNstStatus,
				mc2.nstStatus AS releaseNstStatus,
				<#--发布者推荐人电话-->
				IF(mb3.userType=1,mb3.mobile,mc3.mobile) AS releaseMobile_ed,
				<#--发布者推荐人姓名-->
				IF(mb3.userType=1,mb3.realName,mc3.linkMan) AS releaseName_ed,
				<#--发布者推荐人所属区域-->
				a_s.areaName releaseAreaName,
				<#--接单者推荐人电话-->
				IF(mb4.userType=1,mb4.mobile,mc4.mobile) AS receiveMobile_ed,
				<#--接单者推荐人姓名-->
				IF(mb4.userType=1,mb4.realName,mc4.linkMan) AS receiveName_ed,
				<#--接单者推荐人所属区域-->
				a_s2.areaName receiveAreaName
			FROM
				nst_order_baseinfo nob
			<#--查询车牌号-->
			LEFT JOIN cars car ON nob.carId=car.id
			<#--货源表 -->
			LEFT JOIN member_address ma ON nob.memberAddressId = ma.id
			<#--查询接单人员的姓名和电话-->
			LEFT JOIN member_baseinfo mb ON nob.memberId=mb.memberId
			LEFT JOIN member_certifi mc ON nob.memberId=mc.memberId
			<#--查询发布人员的姓名和电话-->
			LEFT JOIN member_baseinfo mb2 ON nob.confirmMemberId=mb2.memberId
			LEFT JOIN member_certifi mc2 ON nob.confirmMemberId=mc2.memberId
			<#--查询发布人推荐人姓名和电话 区域名称-->
			LEFT JOIN  integral i ON nob.confirmMemberId=i.memberId_ed AND i.type=3
			LEFT JOIN member_baseinfo mb3 ON i.memberId=mb3.memberId
			LEFT JOIN member_certifi mc3 ON i.memberId=mc3.memberId
			LEFT JOIN area_setting a_s ON i.memberId=a_s.memberId
			<#--查询接单者推荐人姓名和电话 区域名称-->
			LEFT JOIN integral i2 ON nob.memberId=i2.memberId_ed AND i2.type=3
			LEFT JOIN member_baseinfo mb4 ON i2.memberId=mb4.memberId
			LEFT JOIN member_certifi mc4 ON i2.memberId=mc4.memberId
			LEFT JOIN area_setting a_s2 ON i2.memberId=a_s2.memberId
			WHERE
 			nob.orderNo = :orderNo
		]]>
    </sql>
	<sql id="getMemberAddressIdByOrderNo" >
    	<![CDATA[
  			SELECT
				memberAddressId
			FROM
				member_address ma
			LEFT JOIN nst_order_baseinfo nob ON ma.id = nob.memberAddressId
			WHERE ma.clients IN (1, 3, 4, 5)
			AND nob.orderNo =:orderNo
		]]>
    </sql>
    
    <sql id="getMemberAddressIdListByOrderNo" >
    	<![CDATA[
  			SELECT
				memberAddressId
			FROM
				member_address ma
			LEFT JOIN nst_order_baseinfo nob ON ma.id = nob.memberAddressId
			WHERE ma.clients IN (1, 3, 4, 5)
			AND nob.orderNo IN 
			<#assign n = orderNoList?size />
			<#if n gt 0>
				(
				<#list orderNoList as omId>
					<#if omId_index != n-1>
							${omId} ,
						<#else>
							${omId}
					</#if>
				</#list>
				) 
			</#if>
		]]>
    </sql>
 <!--同城订单统计列表 -->
    <sql id="getSameCityOrderList">                 
 	<![CDATA[
 		<#--农速通统计列表页-->
		SELECT
			nob.id,
			nob.orderNo,
			nob.f_address_detail,
			nob.s_address_detail,
			ma.s_provinceId,
			ma.s_cityId,
			ma.s_areaId,
		    ma.s_detail AS f_address_detail,
			ma.f_provinceId,
			ma.f_cityId,
			ma.f_areaId,
			ma.f_detail AS s_address_detail,
			nob.orderStatus,
			IF(nob.orderType='1','货源','线路') AS orderType,
			ma.goodsType,
			ma.totalWeight,
			ma.hundredweight,
			ma.totalSize,
			car.carNumber,
			nob.orderTime,
			nob.order_confirmTime,
			nob.order_completeTime,
			<#--接单者电话-->
		  	IF(mb.userType=1,mb.mobile,mc.mobile) AS receiveMobile,
			<#--接单者姓名-->
			IF(mb.userType=1,mb.realName,mc.linkMan) AS receiveName,
			<#--发布者电话-->
			IF(mb2.userType=1,mb2.mobile,mc2.mobile) AS releaseMobile,
			<#--发布者姓名-->
			IF(mb2.userType=1,mb2.realName,mc2.linkMan) AS releaseName,
			<#--发布者类型-->
			IF(mb2.userType=1,'个人','企业') AS releaseUserType,
            mc.nstStatus AS receiveNstStatus,
			mc2.nstStatus AS releaseNstStatus,
			<#--发布者推荐人电话-->
			IF(mb3.userType=1,mb3.mobile,mc3.mobile) AS releaseMobile_ed,
			<#--发布者推荐人姓名-->
			IF(mb3.userType=1,mb3.realName,mc3.linkMan) AS releaseName_ed,
			<#--发布者推荐人所属区域-->
			a_s.areaName releaseAreaName,
			<#--接单者推荐人电话-->
			IF(mb4.userType=1,mb4.mobile,mc4.mobile) AS receiveMobile_ed,
			<#--接单者推荐人姓名-->
			IF(mb4.userType=1,mb4.realName,mc4.linkMan) AS receiveName_ed,
			<#--接单者推荐人所属区域-->
			a_s2.areaName receiveAreaName
		FROM
			nst_order_baseinfo nob
		<#--查询车牌号-->
		LEFT JOIN cars car ON nob.carId=car.id 
		<#--货源表 -->
		LEFT JOIN nst_same_city_address ma ON nob.same_memberAddressId = ma.id
		<#--查询接单人员的姓名和电话-->
		LEFT JOIN member_baseinfo mb ON nob.memberId=mb.memberId
		LEFT JOIN member_certifi mc ON nob.memberId=mc.memberId
		<#--查询发布人员的姓名和电话-->
		LEFT JOIN member_baseinfo mb2 ON nob.confirmMemberId=mb2.memberId
		LEFT JOIN member_certifi mc2 ON nob.confirmMemberId=mc2.memberId
		<#--查询发布人推荐人姓名和电话 区域名称-->
		LEFT JOIN  integral i ON nob.confirmMemberId=i.memberId_ed AND i.type=3
		LEFT JOIN member_baseinfo mb3 ON i.memberId=mb3.memberId
		LEFT JOIN member_certifi mc3 ON i.memberId=mc3.memberId
		LEFT JOIN area_setting a_s ON i.memberId=a_s.memberId
		<#--查询接单者推荐人姓名和电话 区域名称-->
		LEFT JOIN integral i2 ON nob.memberId=i2.memberId_ed AND i2.type=3
		LEFT JOIN member_baseinfo mb4 ON i2.memberId=mb4.memberId
		LEFT JOIN member_certifi mc4 ON i2.memberId=mc4.memberId
		LEFT JOIN area_setting a_s2 ON i2.memberId=a_s2.memberId
		WHERE 1=1 and nob.sourceType=1
		<#if orderNo?exists && orderNo!="" >
			AND nob.orderNo =:orderNo 
		</#if>
		<#if s_provinceId?exists && s_provinceId!="" >
			AND ma.s_provinceId =:s_provinceId 
		</#if>
		<#if s_cityId?exists && s_cityId!="" >
			AND ma.s_cityId =:s_cityId 
		</#if> 
		<#if s_areaId?exists && s_areaId!="" >
			AND ma.s_areaId =:s_areaId 
		</#if>
		<#if f_provinceId?exists && f_provinceId!="" >
			AND ma.f_provinceId =:f_provinceId 
		</#if>
		<#if f_cityId?exists && f_cityId!="" >
			AND ma.f_cityId =:f_cityId 
		</#if>
		<#if f_areaId?exists && f_areaId!="" >
			AND ma.f_areaId =:f_areaId 
		</#if>
		<#if orderStatus?exists && orderStatus!="" >
			AND nob.orderStatus =:orderStatus 
		</#if>
		<#if orderBeginTime?exists && orderBeginTime!="" >
			AND nob.orderTime >=:orderBeginTime 
		</#if>
        <#if orderEndTime?exists && orderEndTime!="" >
		   AND DATE_FORMAT(nob.orderTime,'%Y-%c-%d') <= DATE_FORMAT(:orderEndTime, '%Y-%c-%d')
	    </#if>
		<#if order_completeBeginTime?exists && order_completeBeginTime!="" >
			AND nob.order_completeTime >=:order_completeBeginTime 
		</#if>
		 <#if order_completeEndTime?exists && order_completeEndTime!="" >
		   AND DATE_FORMAT(nob.order_completeTime,'%Y-%c-%d') <= DATE_FORMAT(:order_completeEndTime, '%Y-%c-%d')
	    </#if>
		<#if order_confirmBeginTime?exists && order_confirmBeginTime!="" >
		   	AND nob.order_confirmTime >=:order_confirmBeginTime
	    </#if>
	    <#if order_confirmEndTime?exists && order_confirmEndTime!="" >
			AND nob.order_confirmTime <=:order_confirmEndTime
	    </#if>
		<#if receiveMobile?exists && receiveMobile!="" >
			AND mb.mobile =:receiveMobile 
		</#if>
		<#if releaseMobile?exists && releaseMobile!="" >
			AND mb2.mobile =:releaseMobile 
		</#if>
		<#if releaseMobile_ed?exists && releaseMobile_ed!="" >
			AND mb3.mobile =:releaseMobile_ed 
		</#if>
		<#if releaseAreaName?exists && releaseAreaName!="" >
			AND a_s.areaName =:releaseAreaName 
		</#if>
		<#if receiveMobile_ed?exists && receiveMobile_ed!="" >
			AND mb4.mobile =:receiveMobile_ed 
		</#if>
		<#if receiveAreaName?exists && receiveAreaName!="" >
			AND a_s2.areaName =:receiveAreaName 
		</#if>
		<#if transportType?exists && transportType!="" >
		   AND  car.transportType =:transportType
		</#if>	
		GROUP BY nob.id ORDER BY nob.orderTime desc
		<#if startRow?exists && startRow!="" && endRow?exists && endRow!="" >
				LIMIT :startRow,:endRow
		</#if>
 	]]>
 	</sql>
 	
 	
 	<!--同城订单总数查询  -->
 	<sql id="getSameCityOrderTotal">                 
 	<![CDATA[
 		<#--农速通统计列表页-->
		SELECT count(a.id) FROM 
		( 
			SELECT
				nob.id
			FROM
				nst_order_baseinfo nob
			<#--查询车牌号-->
			LEFT JOIN cars car ON nob.carId=car.id  
			<#--货源表 -->
			LEFT JOIN nst_same_city_address ma ON nob.same_memberAddressId = ma.id
			<#--查询接单人员的姓名和电话-->
			LEFT JOIN member_baseinfo mb ON nob.memberId=mb.memberId
			LEFT JOIN member_certifi mc ON nob.memberId=mc.memberId
			<#--查询发布人员的姓名和电话-->
			LEFT JOIN member_baseinfo mb2 ON nob.confirmMemberId=mb2.memberId
			LEFT JOIN member_certifi mc2 ON nob.confirmMemberId=mc2.memberId
			<#--查询发布人推荐人姓名和电话 区域名称-->
			LEFT JOIN  integral i ON nob.confirmMemberId=i.memberId_ed AND i.type=3
			LEFT JOIN member_baseinfo mb3 ON i.memberId=mb3.memberId
			LEFT JOIN member_certifi mc3 ON i.memberId=mc3.memberId
			LEFT JOIN area_setting a_s ON i.memberId=a_s.memberId
			<#--查询接单者推荐人姓名和电话 区域名称-->
			LEFT JOIN integral i2 ON nob.memberId=i2.memberId_ed AND i2.type=3
			LEFT JOIN member_baseinfo mb4 ON i2.memberId=mb4.memberId
			LEFT JOIN member_certifi mc4 ON i2.memberId=mc4.memberId
			LEFT JOIN area_setting a_s2 ON i2.memberId=a_s2.memberId
			WHERE 1=1 and nob.sourceType=1
			<#if orderNo?exists && orderNo!="" >
				AND nob.orderNo =:orderNo 
			</#if>
			<#if s_provinceId?exists && s_provinceId!="" >
				AND ma.s_provinceId =:s_provinceId 
			</#if>
			<#if s_cityId?exists && s_cityId!="" >
				AND ma.s_cityId =:s_cityId 
			</#if> 
			<#if s_areaId?exists && s_areaId!="" >
				AND ma.s_areaId =:s_areaId 
			</#if>
			<#if f_provinceId?exists && f_provinceId!="" >
				AND ma.f_provinceId =:f_provinceId 
			</#if>
			<#if f_cityId?exists && f_cityId!="" >
				AND ma.f_cityId =:f_cityId 
			</#if>
			<#if f_areaId?exists && f_areaId!="" >
				AND ma.f_areaId =:f_areaId 
			</#if>
			<#if orderStatus?exists && orderStatus!="" >
				AND nob.orderStatus =:orderStatus 
			</#if>
		<#if orderBeginTime?exists && orderBeginTime!="" >
			AND nob.orderTime >=:orderBeginTime 
		</#if>
        <#if orderEndTime?exists && orderEndTime!="" >
		   AND DATE_FORMAT(nob.orderTime,'%Y-%c-%d') <= DATE_FORMAT(:orderEndTime, '%Y-%c-%d')
	    </#if>
		<#if order_completeBeginTime?exists && order_completeBeginTime!="" >
			AND nob.order_completeTime >=:order_completeBeginTime 
		</#if>
		 <#if order_completeEndTime?exists && order_completeEndTime!="" >
		   AND DATE_FORMAT(nob.order_completeTime,'%Y-%c-%d') <= DATE_FORMAT(:order_completeEndTime, '%Y-%c-%d')
	    </#if>
	    <#if order_confirmBeginTime?exists && order_confirmBeginTime!="" >
		   	AND nob.order_confirmTime >=:order_confirmBeginTime
	    </#if>
	    <#if order_confirmEndTime?exists && order_confirmEndTime!="" >
			AND nob.order_confirmTime <=:order_confirmEndTime
	    </#if>
			<#if receiveMobile?exists && receiveMobile!="" >
				AND mb.mobile =:receiveMobile 
			</#if>
			<#if releaseMobile?exists && releaseMobile!="" >
				AND mb2.mobile =:releaseMobile 
			</#if>
			<#if releaseMobile_ed?exists && releaseMobile_ed!="" >
				AND mb3.mobile =:releaseMobile_ed 
			</#if>
			<#if releaseAreaName?exists && releaseAreaName!="" >
				AND a_s.areaName =:releaseAreaName 
			</#if>
			<#if receiveMobile_ed?exists && receiveMobile_ed!="" >
				AND mb4.mobile =:receiveMobile_ed 
			</#if>
			<#if receiveAreaName?exists && receiveAreaName!="" >
				AND a_s2.areaName =:receiveAreaName 
			</#if>
			<#if transportType?exists && transportType!="" >
				 AND  car.transportType =:transportType
			</#if>	
			GROUP BY nob.id
			) a

 	]]>
 	</sql>
 	
 	<!--同城订单详情查询  -->
 	 <sql id="getSameCityOrderDetailByOrderNo" >
    	<![CDATA[
    		<#--农速通统计详情页-->
			SELECT
				nob.id,
				nob.orderNo,
				nob.f_address_detail,
				nob.s_address_detail,
				ma.s_provinceId,
			    ma.s_cityId,
			    ma.s_areaId,
		        ma.s_detail AS f_address_detail,
			    ma.f_provinceId,
			    ma.f_cityId,
			    ma.f_areaId,
			    ma.f_detail AS s_address_detail,
				nob.orderStatus,
				IF(nob.orderType='1','货源','线路') AS orderType,
				ma.goodsType,
				ma.totalWeight,
				ma.hundredweight,
				ma.totalSize,
				car.carNumber,
				nob.orderTime,
				nob.order_confirmTime,
				nob.order_completeTime,
				<#--接单者电话-->
			  	IF(mb.userType=1,mb.mobile,mc.mobile) AS receiveMobile,
				<#--接单者姓名-->
				IF(mb.userType=1,mb.realName,mc.linkMan) AS receiveName,
				<#--发布者电话-->
				IF(mb2.userType=1,mb2.mobile,mc2.mobile) AS releaseMobile,
				<#--发布者姓名-->
				IF(mb2.userType=1,mb2.realName,mc2.linkMan) AS releaseName,
				<#--发布者类型-->
				IF(mb2.userType=1,'个人','企业') AS releaseUserType,
                mc.nstStatus AS receiveNstStatus,
				mc2.nstStatus AS releaseNstStatus,
				<#--发布者推荐人电话-->
				IF(mb3.userType=1,mb3.mobile,mc3.mobile) AS releaseMobile_ed,
				<#--发布者推荐人姓名-->
				IF(mb3.userType=1,mb3.realName,mc3.linkMan) AS releaseName_ed,
				<#--发布者推荐人所属区域-->
				a_s.areaName releaseAreaName,
				<#--接单者推荐人电话-->
				IF(mb4.userType=1,mb4.mobile,mc4.mobile) AS receiveMobile_ed,
				<#--接单者推荐人姓名-->
				IF(mb4.userType=1,mb4.realName,mc4.linkMan) AS receiveName_ed,
				<#--接单者推荐人所属区域-->
				a_s2.areaName receiveAreaName
			FROM
				nst_order_baseinfo nob
			<#--查询车牌号-->
			LEFT JOIN cars car ON nob.carId=car.id 
			<#--货源表 -->
			LEFT JOIN nst_same_city_address ma ON nob.same_memberAddressId = ma.id
			<#--查询接单人员的姓名和电话-->
			LEFT JOIN member_baseinfo mb ON nob.memberId=mb.memberId
			LEFT JOIN member_certifi mc ON nob.memberId=mc.memberId
			<#--查询发布人员的姓名和电话-->
			LEFT JOIN member_baseinfo mb2 ON nob.confirmMemberId=mb2.memberId
			LEFT JOIN member_certifi mc2 ON nob.confirmMemberId=mc2.memberId
			<#--查询发布人推荐人姓名和电话 区域名称-->
			LEFT JOIN  integral i ON nob.confirmMemberId=i.memberId_ed AND i.type=3
			LEFT JOIN member_baseinfo mb3 ON i.memberId=mb3.memberId
			LEFT JOIN member_certifi mc3 ON i.memberId=mc3.memberId
			LEFT JOIN area_setting a_s ON i.memberId=a_s.memberId
			<#--查询接单者推荐人姓名和电话 区域名称-->
			LEFT JOIN integral i2 ON nob.memberId=i2.memberId_ed AND i2.type=3
			LEFT JOIN member_baseinfo mb4 ON i2.memberId=mb4.memberId
			LEFT JOIN member_certifi mc4 ON i2.memberId=mc4.memberId
			LEFT JOIN area_setting a_s2 ON i2.memberId=a_s2.memberId
			WHERE 
 		    nob.orderNo = :orderNo  
		]]>
    </sql>	<!--用于农商友, 根据物流id查找货源信息  -->
	<sql id="getByMemberAddressId" >
    	<![CDATA[
  			SELECT
				t.orderNo, t.productId
			FROM
				product_delivery_detail t
			WHERE type = 1
			AND t.orderNo IS NOT NULL
			<#if isSameAdress?exists && isSameAdress!="" >
				 AND  t.same_memberAddressId =:memberAddressId
			</#if>	
			<#if !isSameAdress?exists >
				 AND t.memberAddressId = :memberAddressId
			</#if>
		]]>
    </sql>
    
    <!--用于农商友, 更新货源信息  -->
    <sql id="updateDeliverStatus" >
    	<![CDATA[
  			UPDATE 
  				order_product_detail 
  			SET 
  				hasDelivered = :deliverStatus 
  			WHERE 
  				orderNo = :orderNo 
  			AND 
  				productId = :productId;
		]]>
    </sql>
</sqlMap>
